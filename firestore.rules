rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper fonksiyon: Kullanıcı giriş yapmış mı?
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper fonksiyon: Kullanıcı kendi verisini mi değiştiriyor?
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper fonksiyon: Kullanıcı yetkili (official/admin) mi?
    function isOfficial() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['official', 'admin'];
    }
    
    // Helper fonksiyon: Kullanıcı admin mi?
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isValidPostStatus(status) {
      return status in ['new', 'in_progress', 'resolved', 'rejected'];
    }

    function postAllowedKeys() {
      return ['authorId', 'title', 'description', 'category', 'imageUrl', 'location', 'district', 'createdAt', 'status', 'upvoteCount', 'upvotedBy', 'commentCount'];
    }

    function hasOnlyPostAllowedKeys(data) {
      return data.keys().hasOnly(postAllowedKeys());
    }

    function commentAllowedKeys() {
      return ['authorId', 'authorFullName', 'authorUsername', 'authorCity', 'authorDistrict', 'authorTitle', 'text', 'parentCommentId', 'rootCommentId', 'depth', 'replyCount', 'replyToAuthorId', 'replyToAuthorFullName', 'replyToAuthorUsername', 'createdAt'];
    }

    function hasOnlyCommentAllowedKeys(data) {
      return data.keys().hasOnly(commentAllowedKeys());
    }
    
    // ========== USERS COLLECTION ==========
    match /users/{userId} {
      // Okuma: Herkes kendi profilini okuyabilir, diğerlerini de okuyabilir (profil görüntüleme için)
      allow read: if isAuthenticated();
      
      // Oluşturma: Sadece kendi profilini oluşturabilir
      allow create: if isOwner(userId);
      
      // Güncelleme: Sadece kendi profilini güncelleyebilir (admin hariç)
      allow update: if (isOwner(userId) && (
        // username ilk defa set edilebilir ve index ile doğrulanmalı
        (
          (!('username' in resource.data) || resource.data.username == '') &&
          request.resource.data.username is string &&
          request.resource.data.username.size() >= 3 &&
          request.resource.data.username.size() <= 20 &&
          existsAfter(/databases/$(database)/documents/usernames/$(request.resource.data.username)) &&
          getAfter(/databases/$(database)/documents/usernames/$(request.resource.data.username)).data.uid == request.auth.uid
        ) ||
        // username değişmiyorsa normal update
        (request.resource.data.username == resource.data.username)
      )) || isAdmin();
      
      // Silme: Sadece admin silebilir
      allow delete: if isAdmin();
    }

    // ========== USERNAMES INDEX COLLECTION ==========
    match /usernames/{username} {
      allow read: if isAuthenticated();

      // Username sadece bir kez oluşturulur; doc id = username (lowercase)
      allow create: if isAuthenticated() &&
                   request.resource.data.uid == request.auth.uid &&
                   username.matches('^[a-z0-9_]{3,20}$');

      allow update, delete: if false;
    }
    
    // ========== POSTS COLLECTION ==========
    match /posts/{postId} {
      // Okuma: Giriş yapmış herkes okuyabilir
      allow read: if isAuthenticated();
      
      // Oluşturma: Giriş yapmış herkes post oluşturabilir
      allow create: if isAuthenticated() && 
                       isOwner(request.resource.data.authorId) &&
                       hasOnlyPostAllowedKeys(request.resource.data) &&
                       request.resource.data.authorId is string &&
                       request.resource.data.title is string &&
                       request.resource.data.description is string &&
                       request.resource.data.category is string &&
                       request.resource.data.status is string &&
                       isValidPostStatus(request.resource.data.status);
      
      // Güncelleme: 
      // - Post sahibi kendi postunu güncelleyebilir (title, description, category, status)
      // - Yetkili kullanıcılar status'u güncelleyebilir
      // - Herhangi bir giriş yapmış kullanıcı upvote yapabilir (upvotedBy, upvoteCount)
      allow update: if isAuthenticated() && (
        // Post sahibi belirli alanları güncelleyebilir (status dahil - kendi postunu çözüldü olarak işaretleyebilir)
        (isOwner(resource.data.authorId) && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['title', 'description', 'category', 'imageUrl', 'status']) &&
         (!('status' in request.resource.data) || isValidPostStatus(request.resource.data.status))) ||
        // Yetkili kullanıcılar sadece status'u güncelleyebilir
        (isOfficial() && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']) &&
         isValidPostStatus(request.resource.data.status)) ||
        // Herhangi bir giriş yapmış kullanıcı upvote yapabilir (upvotedBy ve upvoteCount)
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['upvotedBy', 'upvoteCount'])) ||
        // Herhangi bir giriş yapmış kullanıcı commentCount'u +1 artırabilir
        (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['commentCount']) &&
          // FieldValue.increment() kullanıldığında bazı durumlarda eşitlik kontrolü sorun çıkarabiliyor.
          // Bu yüzden sadece commentCount alanının güncellendiğini doğrulayıp izin veriyoruz.
          request.resource.data.commentCount is int
        )
      );
      
      // Silme: Post sahibi veya admin silebilir
      allow delete: if isAuthenticated() && 
                       (isOwner(resource.data.authorId) || isAdmin());
      
      // ========== COMMENTS SUBCOLLECTION ==========
      match /comments/{commentId} {
        // Okuma: Giriş yapmış herkes okuyabilir
        allow read: if isAuthenticated();
        
        // Oluşturma: Giriş yapmış herkes yorum yapabilir
        allow create: if isAuthenticated() && 
                         isOwner(request.resource.data.authorId) &&
                         hasOnlyCommentAllowedKeys(request.resource.data) &&
                         request.resource.data.authorId is string &&
                         request.resource.data.authorFullName is string &&
                         request.resource.data.authorUsername is string &&
                         request.resource.data.authorCity is string &&
                         request.resource.data.authorDistrict is string &&
                         request.resource.data.authorTitle is string &&
                         request.resource.data.text is string;
        
        // Güncelleme: Sadece yorum sahibi güncelleyebilir
        allow update: if isAuthenticated() && (
                         // Yorum sahibi kendi yorumunu güncelleyebilir
                         isOwner(resource.data.authorId) ||
                         // Reply atılınca root yorumun replyCount alanı +1 güncellenebilsin
                         (
                           // Eski yorumlarda depth alanı olmayabilir => top-level kabul et
                           (resource.data.depth == 0 || resource.data.depth == null) &&
                           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyCount']) &&
                           // replyCount increment için sadece tip kontrolü yapıyoruz
                           request.resource.data.replyCount is int
                         )
                       );
        
        // Silme: Yorum sahibi veya admin silebilir
        allow delete: if isAuthenticated() && 
                         (isOwner(resource.data.authorId) || isAdmin());
      }
    }
  }
}

