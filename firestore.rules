rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper fonksiyon: Kullanıcı giriş yapmış mı?
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper fonksiyon: Kullanıcı kendi verisini mi değiştiriyor?
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Helper fonksiyon: Kullanıcı yetkili (official/admin) mi?
    function isOfficial() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['official', 'admin'];
    }
    
    // Helper fonksiyon: Kullanıcı admin mi?
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isValidPostStatus(status) {
      return status in ['new', 'in_progress', 'resolved', 'rejected'];
    }

    function postAllowedKeys() {
      return ['authorId', 'title', 'description', 'category', 'imageUrl', 'location', 'district', 'createdAt', 'status', 'upvoteCount', 'upvotedBy', 'commentCount', 'updateCount'];
    }

    function hasOnlyPostAllowedKeys(data) {
      return data.keys().hasOnly(postAllowedKeys());
    }

    function commentAllowedKeys() {
      return ['authorId', 'authorFullName', 'authorUsername', 'authorCity', 'authorDistrict', 'authorTitle', 'text', 'parentCommentId', 'rootCommentId', 'depth', 'replyCount', 'replyToAuthorId', 'replyToAuthorFullName', 'replyToAuthorUsername', 'createdAt', 'isDeleted', 'deletedBy', 'postId'];
    }

    function hasOnlyCommentAllowedKeys(data) {
      return data.keys().hasOnly(commentAllowedKeys());
    }
    
    // ========== USERS COLLECTION ==========
    match /users/{userId} {
      // Okuma: Herkes kendi profilini okuyabilir, diğerlerini de okuyabilir (profil görüntüleme için)
      allow read: if isAuthenticated();
      
      // Oluşturma: Sadece kendi profilini oluşturabilir
      allow create: if isOwner(userId);
      
      // Güncelleme: Sadece kendi profilini güncelleyebilir (admin hariç)
      allow update: if (isOwner(userId) && (
        // username ilk defa set edilebilir ve index ile doğrulanmalı
        (
          (!('username' in resource.data) || resource.data.username == '') &&
          request.resource.data.username is string &&
          request.resource.data.username.size() >= 3 &&
          request.resource.data.username.size() <= 20 &&
          existsAfter(/databases/$(database)/documents/usernames/$(request.resource.data.username)) &&
          getAfter(/databases/$(database)/documents/usernames/$(request.resource.data.username)).data.uid == request.auth.uid
        ) ||
        // username değişmiyorsa normal update
        (request.resource.data.username == resource.data.username)
      )) || isAdmin();
      
      // Silme: Sadece admin silebilir
      allow delete: if isAdmin();
    }

    // ========== USERNAMES INDEX COLLECTION ==========
    match /usernames/{username} {
      allow read: if isAuthenticated();

      // Username sadece bir kez oluşturulur; doc id = username (lowercase)
      allow create: if isAuthenticated() &&
                   request.resource.data.uid == request.auth.uid &&
                   username.matches('^[a-z0-9_]{3,20}$');

      allow update, delete: if false;
    }
    
    // ========== POSTS COLLECTION ==========
    match /posts/{postId} {
      // Okuma: Giriş yapmış herkes okuyabilir
      allow read: if isAuthenticated();
      
      // Oluşturma: Giriş yapmış herkes post oluşturabilir
      allow create: if isAuthenticated() && 
                       isOwner(request.resource.data.authorId) &&
                       hasOnlyPostAllowedKeys(request.resource.data) &&
                       request.resource.data.authorId is string &&
                       request.resource.data.title is string &&
                       request.resource.data.description is string &&
                       request.resource.data.category is string &&
                       request.resource.data.status is string &&
                       isValidPostStatus(request.resource.data.status);
      
      // Güncelleme: 
      // - Post sahibi kendi postunu güncelleyebilir (title, description, category, status)
      // - Yetkili kullanıcılar status'u güncelleyebilir
      // - Herhangi bir giriş yapmış kullanıcı upvote yapabilir (upvotedBy, upvoteCount)
      allow update: if isAuthenticated() && (
        // Post sahibi belirli alanları güncelleyebilir (status dahil - kendi postunu çözüldü olarak işaretleyebilir)
        (isOwner(resource.data.authorId) && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['title', 'description', 'category', 'imageUrl', 'status', 'updateCount']) &&
         (!('status' in request.resource.data) || isValidPostStatus(request.resource.data.status))) ||
        // Yetkili kullanıcılar sadece status ve updateCount'u güncelleyebilir
        (isOfficial() && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updateCount']) &&
         isValidPostStatus(request.resource.data.status)) ||
        // Herhangi bir giriş yapmış kullanıcı upvote yapabilir (upvotedBy ve upvoteCount)
        (request.resource.data.diff(resource.data).affectedKeys().hasOnly(['upvotedBy', 'upvoteCount'])) ||
        // Herhangi bir giriş yapmış kullanıcı commentCount'u +1 artırabilir
        (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['commentCount']) &&
          // FieldValue.increment() kullanıldığında bazı durumlarda eşitlik kontrolü sorun çıkarabiliyor.
          // Bu yüzden sadece commentCount alanının güncellendiğini doğrulayıp izin veriyoruz.
          request.resource.data.commentCount is int
        )
      );
      
      // Silme: Post sahibi veya admin silebilir
      allow delete: if isAuthenticated() && 
                       (isOwner(resource.data.authorId) || isAdmin());
      
      // ========== COMMENTS SUBCOLLECTION ==========
      match /comments/{commentId} {
        // Okuma: Giriş yapmış herkes okuyabilir
        allow read: if isAuthenticated();
        
        // Oluşturma: Giriş yapmış herkes yorum yapabilir
        allow create: if isAuthenticated() && 
                         isOwner(request.resource.data.authorId) &&
                         hasOnlyCommentAllowedKeys(request.resource.data) &&
                         request.resource.data.authorId is string &&
                         request.resource.data.authorFullName is string &&
                         request.resource.data.authorUsername is string &&
                         request.resource.data.authorCity is string &&
                         request.resource.data.authorDistrict is string &&
                         request.resource.data.authorTitle is string &&
                         request.resource.data.text is string;
        
        // Güncelleme: Yorum sahibi veya admin güncelleyebilir
        allow update: if isAuthenticated() && (
                         // Yorum sahibi kendi yorumunu güncelleyebilir
                         isOwner(resource.data.authorId) ||
                         // Admin herhangi bir yorumu güncelleyebilir (soft delete için)
                         isAdmin() ||
                         // Reply atılınca herhangi bir yorumun replyCount alanı +1 güncellenebilsin
                         (
                           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['replyCount']) &&
                           // replyCount increment için sadece tip kontrolü yapıyoruz
                           request.resource.data.replyCount is int
                         )
                       );
        
        // Silme: Yorum sahibi veya admin silebilir
        allow delete: if isAuthenticated() && 
                         (isOwner(resource.data.authorId) || isAdmin());
      }
      
      // ========== STATUS UPDATES SUBCOLLECTION ==========
      match /statusUpdates/{updateId} {
        // Okuma: Herkes okuyabilir
        allow read: if isAuthenticated();
        
        // Oluşturma: Post sahibi veya yetkili
        allow create: if isAuthenticated() && (
                         // Post sahibi
                         get(/databases/$(database)/documents/posts/$(postId)).data.authorId == request.auth.uid ||
                         // Yetkili veya admin
                         isOfficial()
                       ) && 
                       // Alan kontrolü
                       request.resource.data.keys().hasOnly([
                         'postId', 'status', 'note', 'authorId',
                         'authorFullName', 'authorUsername', 
                         'authorCity', 'authorDistrict', 'authorTitle',
                         'createdAt'
                       ]) &&
                       request.resource.data.note is string &&
                       request.resource.data.note.size() > 0 &&
                       request.resource.data.note.size() <= 500;
        
        // Güncelleme ve silme yasak
        allow update, delete: if false;
      }
    }
    // ========== COLLECTION GROUP QUERIES ==========
    // Kullanıcının tüm yorumlarını (hangi post'ta olursa olsun) çekebilmesi için gerekli
    match /{path=**}/comments/{commentId} {
      allow read: if isAuthenticated();
    }
  }
}
